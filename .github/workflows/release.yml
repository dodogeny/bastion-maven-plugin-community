name: Continuous Delivery Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip Maven Central deployment and GitHub release)'
        required: false
        default: false
        type: boolean
      force_version:
        description: 'Force specific version (leave empty to use POM version)'
        required: false
        type: string
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - ".github/**"
      - "!.github/workflows/release.yml"

env:
  JAVA_VERSION: 21
  MAVEN_OPTS: "-Xmx2g -XX:+UseG1GC"

jobs:
  # ============================================================================
  # Pre-flight Checks
  # ============================================================================
  preflight:
    name: Pre-flight checks
    runs-on: ubuntu-latest
    if: github.repository_owner == 'dodogeny'
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.checks.outputs.should_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from POM
        id: version
        run: |
          POM_VERSION=$(grep -oP '<revision>\K[^<]+' pom.xml | head -1)

          if [ -z "$POM_VERSION" ]; then
            echo "‚ùå ERROR: Could not extract version from pom.xml"
            exit 1
          fi

          # Use forced version if provided (manual workflow dispatch)
          if [ -n "${{ github.event.inputs.force_version }}" ]; then
            VERSION="${{ github.event.inputs.force_version }}"
            echo "‚ö†Ô∏è  Using forced version: $VERSION"
          else
            VERSION="$POM_VERSION"
            echo "‚úì Using POM version: $VERSION"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "pom_version=$POM_VERSION" >> $GITHUB_OUTPUT

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if version matches semver format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "‚ùå ERROR: Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH[-QUALIFIER]"
            exit 1
          fi

          echo "‚úì Version format is valid: $VERSION"

      - name: Check if tag already exists
        id: checks
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if tag exists
          if git rev-parse "v${VERSION}" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Tag v${VERSION} already exists"
            echo "should_release=false" >> $GITHUB_OUTPUT

            # Fail if not a manual workflow dispatch
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              echo "‚ùå ERROR: Tag already exists and this is not a manual run"
              exit 1
            fi
          else
            echo "‚úì Tag v${VERSION} does not exist yet"
            echo "should_release=true" >> $GITHUB_OUTPUT
          fi

          # Get previous version for comparison
          PREV_TAG=$(git tag -l --sort=-v:refname | head -1)
          echo "prev_tag=${PREV_TAG:-none}" >> $GITHUB_OUTPUT
          echo "Previous version: ${PREV_TAG:-none}"

      - name: Validate CHANGELOG entry
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Check if CHANGELOG.md has an entry for this version
          if ! grep -q "\[${VERSION}\]" CHANGELOG.md && ! grep -q "@project.version@" CHANGELOG.md; then
            echo "‚ö†Ô∏è  WARNING: No CHANGELOG entry found for version ${VERSION}"
            echo "Consider adding release notes to CHANGELOG.md"
          else
            echo "‚úì CHANGELOG entry found"
          fi

  # ============================================================================
  # Update Documentation with Version
  # ============================================================================
  update-docs:
    name: Update documentation with version
    needs: preflight
    runs-on: ubuntu-latest
    if: needs.preflight.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Update version placeholders in documentation
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"

          echo "=== Updating Documentation with Version ${VERSION} ==="

          # Show files before update
          echo "Checking for @project.version@ placeholders:"
          grep -n "@project.version@" README.md QUICKSTART.md CHANGELOG.md || echo "No placeholders found"

          # Replace @project.version@ with actual version
          sed -i "s/@project\.version@/${VERSION}/g" README.md
          sed -i "s/@project\.version@/${VERSION}/g" QUICKSTART.md
          sed -i "s/@project\.version@/${VERSION}/g" CHANGELOG.md

          echo ""
          echo "Files after update:"
          git status README.md QUICKSTART.md CHANGELOG.md

          echo "‚úì Updated version placeholders in documentation"

      - name: Commit and push documentation updates
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if ! git diff --quiet README.md QUICKSTART.md CHANGELOG.md; then
            echo "Changes detected, committing..."

            # Commit and push changes
            git add README.md QUICKSTART.md CHANGELOG.md
            git commit -m "docs: Update version to ${VERSION} in documentation" \
                       -m "Automated documentation update for release v${VERSION}" \
                       -m "Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"

            git push origin main

            echo "‚úì Documentation updated and pushed successfully"
          else
            echo "‚úì No documentation changes needed (already up to date)"
          fi

  # ============================================================================
  # Build and Test
  # ============================================================================
  build:
    name: Build and test
    needs: [preflight, update-docs]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.preflight.outputs.should_release == 'true' &&
      (needs.update-docs.result == 'success' || needs.update-docs.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest commit including doc updates
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Display build environment
        run: |
          echo "=== Build Environment ==="
          echo "Java version: $(java -version 2>&1 | head -1)"
          echo "Maven version: $(mvn -v | head -1)"
          echo "Build version: ${{ needs.preflight.outputs.version }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "========================"

      - name: Clear Maven cache
        run: |
          echo "Clearing Maven cache for io.github.dodogeny..."
          rm -rf ~/.m2/repository/io/github/dodogeny
          find ~/.m2/repository -name "*.lastUpdated" -delete 2>/dev/null || true
          echo "‚úì Cache cleared"

      - name: Run tests
        run: |
          echo "Running tests for version ${{ needs.preflight.outputs.version }}"
          mvn -B clean test \
            -Drevision=${{ needs.preflight.outputs.version }} \
            -DskipToolchain=true

      - name: Build project
        run: |
          echo "Building version ${{ needs.preflight.outputs.version }}"
          mvn -B package \
            -Drevision=${{ needs.preflight.outputs.version }} \
            -DskipToolchain=true \
            -DskipTests

      - name: Verify artifacts exist
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          MISSING=0

          echo "=== Verifying Distribution Artifacts ==="

          ARTIFACTS=(
            "distribution/target/bastion-maven-plugin-${VERSION}-bin.zip"
            "distribution/target/bastion-maven-plugin-${VERSION}-bin-unix.tar.gz"
            "distribution/target/bastion-maven-plugin-${VERSION}-docs.zip"
            "distribution/target/bastion-maven-plugin-${VERSION}-src.zip"
            "distribution/target/bastion-maven-plugin-${VERSION}-src.tar.gz"
          )

          for artifact in "${ARTIFACTS[@]}"; do
            if [ -f "$artifact" ]; then
              SIZE=$(du -h "$artifact" | cut -f1)
              echo "‚úì $artifact ($SIZE)"
            else
              echo "‚ùå MISSING: $artifact"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ $MISSING -gt 0 ]; then
            echo "‚ùå ERROR: $MISSING artifact(s) missing"
            exit 1
          fi

          echo "‚úì All artifacts present"

      - name: Generate checksums
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          cd distribution/target

          echo "=== Generating SHA-256 Checksums ==="
          for file in bastion-maven-plugin-${VERSION}*.{zip,tar.gz}; do
            if [ -f "$file" ]; then
              sha256sum "$file" > "${file}.sha256"
              echo "‚úì Generated checksum for $file"
            fi
          done

          # Create checksums file
          sha256sum bastion-maven-plugin-${VERSION}*.{zip,tar.gz} > SHA256SUMS.txt 2>/dev/null || true

          echo ""
          echo "=== Checksums ==="
          cat SHA256SUMS.txt || echo "No checksums generated"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution-${{ needs.preflight.outputs.version }}
          path: |
            distribution/target/bastion-maven-plugin-${{ needs.preflight.outputs.version }}*
          retention-days: 7
          if-no-files-found: error

  # ============================================================================
  # Release to Maven Central
  # ============================================================================
  release:
    name: Release to Maven Central
    needs: [preflight, build]
    runs-on: ubuntu-latest
    if: needs.preflight.outputs.should_release == 'true' && github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest commit including doc updates
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}
          cache: maven

      - name: Import GPG key
        run: |
          echo "Importing GPG keys..."
          echo "${{ secrets.GPG_PUBLIC_KEY }}" | gpg --import
          echo "${{ secrets.GPG_SECRET_KEY }}" | gpg --import --no-tty --batch --yes

          # Verify keys were imported
          if gpg --list-secret-keys --keyid-format=long | grep -q sec; then
            echo "‚úì GPG keys imported successfully"
          else
            echo "‚ùå ERROR: Failed to import GPG keys"
            exit 1
          fi

      - name: Verify secrets
        run: |
          MISSING=0

          if [ -z "${{ secrets.OSSRH_USERNAME }}" ]; then
            echo "‚ùå OSSRH_USERNAME not set"
            MISSING=$((MISSING + 1))
          fi

          if [ -z "${{ secrets.OSSRH_TOKEN }}" ]; then
            echo "‚ùå OSSRH_TOKEN not set"
            MISSING=$((MISSING + 1))
          fi

          if [ -z "${{ secrets.GPG_PASSPHRASE }}" ]; then
            echo "‚ùå GPG_PASSPHRASE not set"
            MISSING=$((MISSING + 1))
          fi

          if [ $MISSING -gt 0 ]; then
            echo "‚ùå ERROR: $MISSING required secret(s) not set"
            exit 1
          fi

          echo "‚úì All required secrets are configured"

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <settings xmlns="http://maven.apache.org/SETTINGS/1.2.0"
                    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                    xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.2.0 https://maven.apache.org/xsd/settings-1.2.0.xsd">
            <servers>
              <server>
                <id>central</id>
                <username>${{ secrets.OSSRH_USERNAME }}</username>
                <password>${{ secrets.OSSRH_TOKEN }}</password>
              </server>
            </servers>

            <profiles>
              <profile>
                <id>central</id>
                <activation>
                  <activeByDefault>true</activeByDefault>
                </activation>
                <properties>
                  <gpg.executable>gpg</gpg.executable>
                  <gpg.passphrase>${{ secrets.GPG_PASSPHRASE }}</gpg.passphrase>
                </properties>
              </profile>
            </profiles>

            <activeProfiles>
              <activeProfile>central</activeProfile>
            </activeProfiles>
          </settings>
          EOF
          echo "‚úì Maven settings.xml configured"

      - name: Clean Maven cache
        run: |
          rm -rf ~/.m2/repository/io/github/dodogeny
          rm -rf ~/.m2/repository/org/apache/maven/plugins/maven-gpg-plugin
          find ~/.m2/repository -name "*.lastUpdated" -delete 2>/dev/null || true

      - name: Deploy to Maven Central
        run: |
          export GPG_TTY=$(tty)
          VERSION="${{ needs.preflight.outputs.version }}"

          echo "=== Deploying version ${VERSION} to Maven Central ==="

          mvn -B deploy \
            --no-transfer-progress \
            -Drevision=${VERSION} \
            -DskipToolchain=true \
            -DskipTests \
            -Dgpg.skip=false

          echo "‚úì Deployment completed"
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_CENTRAL_TOKEN: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

  # ============================================================================
  # Create GitHub Release
  # ============================================================================
  github-release:
    name: Create GitHub release
    needs: [preflight, build, release]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.preflight.outputs.should_release == 'true' &&
      (needs.release.result == 'success' || needs.release.result == 'skipped') &&
      github.event.inputs.dry_run != 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Get latest commit including doc updates
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: distribution-${{ needs.preflight.outputs.version }}
          path: distribution/target/

      - name: Create Git tag
        uses: rickstaa/action-create-tag@v1
        id: tag_create
        with:
          tag: v${{ needs.preflight.outputs.version }}
          tag_exists_error: false
          message: "Release v${{ needs.preflight.outputs.version }}"

      - name: Extract CHANGELOG entry
        id: changelog
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"

          # Try to extract changelog entry for this version
          if grep -q "\[${VERSION}\]" CHANGELOG.md || grep -q "@project.version@" CHANGELOG.md; then
            # Extract section between this version and next version header
            CHANGELOG_ENTRY=$(awk "/## \[${VERSION}\]|## \[@project.version@\]/,/## \[[0-9]/" CHANGELOG.md | head -n -1 | tail -n +2)

            if [ -n "$CHANGELOG_ENTRY" ]; then
              echo "‚úì Extracted CHANGELOG entry"
              echo "changelog_found=true" >> $GITHUB_OUTPUT
              # Save to file to preserve formatting
              echo "$CHANGELOG_ENTRY" > /tmp/changelog_entry.md
            else
              echo "‚ö†Ô∏è  CHANGELOG section found but empty"
              echo "changelog_found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è  No CHANGELOG entry for version ${VERSION}"
            echo "changelog_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          PREV_TAG="${{ needs.preflight.outputs.prev_tag }}"

          echo "=== Generating Release Notes ==="
          echo "Current version: $VERSION"
          echo "Previous tag: ${PREV_TAG:-none}"

          # Start release notes
          cat > release_notes.md <<EOF
          ## Installation

          Add the following plugin to your Maven \`pom.xml\`:

          \`\`\`xml
          <plugin>
              <groupId>io.github.dodogeny</groupId>
              <artifactId>bastion-maven-community-plugin</artifactId>
              <version>${VERSION}</version>
          </plugin>
          \`\`\`

          EOF

          # Add CHANGELOG entry if available
          if [ "${{ steps.changelog.outputs.changelog_found }}" == "true" ]; then
            echo "## What's Changed" >> release_notes.md
            echo "" >> release_notes.md
            cat /tmp/changelog_entry.md >> release_notes.md
            echo "" >> release_notes.md
          else
            # Generate detailed changelog from commits and PRs
            echo "## What's Changed" >> release_notes.md
            echo "" >> release_notes.md

            if [ -z "$PREV_TAG" ]; then
              echo "### Commits" >> release_notes.md
              git log --pretty=format:"- %s (%h)" --no-merges | head -20 >> release_notes.md
            else
              # Get commits between versions
              echo "### Commits Since ${PREV_TAG}" >> release_notes.md
              echo "" >> release_notes.md

              # Extract PR numbers and categorize commits
              git log ${PREV_TAG}..HEAD --pretty=format:"%s|%h|%an" --no-merges > /tmp/commits.txt

              # Process commits and extract PR references
              echo "#### üöÄ Features & Enhancements" >> release_notes.md
              grep -iE "^(feat|feature|add|added|new):" /tmp/commits.txt | while IFS='|' read -r subject hash author; do
                PR_NUM=$(echo "$subject" | grep -oP '#\d+' | head -1)
                if [ -n "$PR_NUM" ]; then
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash)) [${PR_NUM}](https://github.com/${{ github.repository }}/pull/${PR_NUM#\#})" >> release_notes.md
                else
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash))" >> release_notes.md
                fi
              done || echo "_No new features_" >> release_notes.md
              echo "" >> release_notes.md

              echo "#### üêõ Bug Fixes" >> release_notes.md
              grep -iE "^(fix|fixed|bugfix|bug):" /tmp/commits.txt | while IFS='|' read -r subject hash author; do
                PR_NUM=$(echo "$subject" | grep -oP '#\d+' | head -1)
                if [ -n "$PR_NUM" ]; then
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash)) [${PR_NUM}](https://github.com/${{ github.repository }}/pull/${PR_NUM#\#})" >> release_notes.md
                else
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash))" >> release_notes.md
                fi
              done || echo "_No bug fixes_" >> release_notes.md
              echo "" >> release_notes.md

              echo "#### üìö Documentation" >> release_notes.md
              grep -iE "^(docs|doc|documentation):" /tmp/commits.txt | while IFS='|' read -r subject hash author; do
                PR_NUM=$(echo "$subject" | grep -oP '#\d+' | head -1)
                if [ -n "$PR_NUM" ]; then
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash)) [${PR_NUM}](https://github.com/${{ github.repository }}/pull/${PR_NUM#\#})" >> release_notes.md
                else
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash))" >> release_notes.md
                fi
              done || echo "_No documentation changes_" >> release_notes.md
              echo "" >> release_notes.md

              echo "#### üîß Maintenance & Chores" >> release_notes.md
              grep -iE "^(chore|refactor|test|ci|build|perf):" /tmp/commits.txt | while IFS='|' read -r subject hash author; do
                PR_NUM=$(echo "$subject" | grep -oP '#\d+' | head -1)
                if [ -n "$PR_NUM" ]; then
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash)) [${PR_NUM}](https://github.com/${{ github.repository }}/pull/${PR_NUM#\#})" >> release_notes.md
                else
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash))" >> release_notes.md
                fi
              done || echo "_No maintenance changes_" >> release_notes.md
              echo "" >> release_notes.md

              echo "#### üì¶ Other Changes" >> release_notes.md
              grep -viE "^(feat|feature|add|added|new|fix|fixed|bugfix|bug|docs|doc|documentation|chore|refactor|test|ci|build|perf):" /tmp/commits.txt | while IFS='|' read -r subject hash author; do
                PR_NUM=$(echo "$subject" | grep -oP '#\d+' | head -1)
                if [ -n "$PR_NUM" ]; then
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash)) [${PR_NUM}](https://github.com/${{ github.repository }}/pull/${PR_NUM#\#})" >> release_notes.md
                else
                  echo "- $subject by @$author ([$hash](https://github.com/${{ github.repository }}/commit/$hash))" >> release_notes.md
                fi
              done || echo "_No other changes_" >> release_notes.md
              echo "" >> release_notes.md
            fi
            echo "" >> release_notes.md
          fi

          # Add Maven Central section
          cat >> release_notes.md <<EOF
          ## Maven Central

          üöÄ This release has been deployed to Maven Central and will be available within 30 minutes.

          - **Maven Central**: https://central.sonatype.com/artifact/io.github.dodogeny/bastion-maven-community-plugin/${VERSION}
          - **Deployment Status**: [Central Portal](https://central.sonatype.com/publishing/deployments)

          ## Artifacts

          ### Binary Distributions
          - **bastion-maven-plugin-${VERSION}-bin.zip** - Windows/cross-platform distribution (with checksums)
          - **bastion-maven-plugin-${VERSION}-bin-unix.tar.gz** - Unix/Linux/macOS distribution (with checksums)

          ### Documentation
          - **bastion-maven-plugin-${VERSION}-docs.zip** - Complete documentation package

          ### Source Code
          - **bastion-maven-plugin-${VERSION}-src.zip** - Full source code (zip format)
          - **bastion-maven-plugin-${VERSION}-src.tar.gz** - Full source code (tar.gz format)

          ### Verification

          #### Checksums
          SHA-256 checksums are provided for all GitHub release artifacts (\`.sha256\` files):

          \`\`\`bash
          sha256sum -c bastion-maven-plugin-${VERSION}-bin.zip.sha256
          \`\`\`

          #### GPG Signatures
          GPG signatures (\`.asc\` files) are available on [Maven Central](https://central.sonatype.com/artifact/io.github.dodogeny/bastion-maven-plugin-parent/${VERSION}) for all artifacts. To verify:

          \`\`\`bash
          # Download from Maven Central and verify
          gpg --verify bastion-maven-plugin-${VERSION}.jar.asc bastion-maven-plugin-${VERSION}.jar
          \`\`\`

          EOF

          # Add comparison link if previous tag exists
          if [ -n "$PREV_TAG" ]; then
            echo "---" >> release_notes.md
            echo "" >> release_notes.md
            echo "üì¶ **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}" >> release_notes.md
          fi

          echo ""
          echo "=== Release Notes Preview ==="
          cat release_notes.md
          echo "========================="

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"

          echo "=== Creating GitHub Release ==="

          # Create release with all artifacts (checksums for verification)
          # Note: GPG .asc signatures are available on Maven Central
          gh release create "v${VERSION}" \
            --title "Bastion Maven Plugin Community v${VERSION}" \
            --notes-file release_notes.md \
            distribution/target/bastion-maven-plugin-${VERSION}-bin.zip \
            distribution/target/bastion-maven-plugin-${VERSION}-bin.zip.sha256 \
            distribution/target/bastion-maven-plugin-${VERSION}-bin-unix.tar.gz \
            distribution/target/bastion-maven-plugin-${VERSION}-bin-unix.tar.gz.sha256 \
            distribution/target/bastion-maven-plugin-${VERSION}-docs.zip \
            distribution/target/bastion-maven-plugin-${VERSION}-docs.zip.sha256 \
            distribution/target/bastion-maven-plugin-${VERSION}-src.zip \
            distribution/target/bastion-maven-plugin-${VERSION}-src.zip.sha256 \
            distribution/target/bastion-maven-plugin-${VERSION}-src.tar.gz \
            distribution/target/bastion-maven-plugin-${VERSION}-src.tar.gz.sha256

          echo "‚úì GitHub release created successfully"
          echo "üì¶ Release URL: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"

  # ============================================================================
  # Email Notification
  # ============================================================================
  notify:
    name: Send release notification
    needs: [preflight, build, release, github-release]
    runs-on: ubuntu-latest
    if: |
      always() &&
      needs.github-release.result == 'success' &&
      github.event.inputs.dry_run != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: distribution-${{ needs.preflight.outputs.version }}
          path: distribution/target/

      - name: Prepare email content
        id: email_content
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          PREV_TAG="${{ needs.preflight.outputs.prev_tag }}"
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
          MAVEN_CENTRAL_URL="https://central.sonatype.com/artifact/io.github.dodogeny/bastion-maven-community-plugin/${VERSION}"

          # Get artifact sizes
          cd distribution/target
          BIN_SIZE=$(du -h bastion-maven-plugin-${VERSION}-bin.zip 2>/dev/null | cut -f1 || echo "N/A")
          UNIX_SIZE=$(du -h bastion-maven-plugin-${VERSION}-bin-unix.tar.gz 2>/dev/null | cut -f1 || echo "N/A")
          DOCS_SIZE=$(du -h bastion-maven-plugin-${VERSION}-docs.zip 2>/dev/null | cut -f1 || echo "N/A")
          cd ../..

          # Count commits since last version
          if [ -n "$PREV_TAG" ]; then
            COMMIT_COUNT=$(git rev-list ${PREV_TAG}..HEAD --count)
            CONTRIBUTORS=$(git log ${PREV_TAG}..HEAD --pretty=format:"%an" | sort -u | wc -l)
          else
            COMMIT_COUNT=$(git rev-list HEAD --count | head -20)
            CONTRIBUTORS=$(git log --pretty=format:"%an" | sort -u | head -20 | wc -l)
          fi

          # Get PR count
          if [ -n "$PREV_TAG" ]; then
            PR_COUNT=$(git log ${PREV_TAG}..HEAD --pretty=format:"%s" --no-merges | grep -c '#[0-9]\+' || echo "0")
          else
            PR_COUNT="0"
          fi

          # Create email body
          cat > email_body.html <<EOF
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }
              .header h1 { margin: 0; font-size: 28px; }
              .header p { margin: 10px 0 0 0; font-size: 16px; opacity: 0.9; }
              .content { background: #f8f9fa; padding: 30px; }
              .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .section h2 { margin-top: 0; color: #667eea; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
              .stats { display: flex; flex-wrap: wrap; gap: 15px; margin: 20px 0; }
              .stat-box { flex: 1; min-width: 150px; background: #f0f4ff; padding: 15px; border-radius: 6px; text-align: center; }
              .stat-box .number { font-size: 32px; font-weight: bold; color: #667eea; }
              .stat-box .label { font-size: 14px; color: #666; margin-top: 5px; }
              .artifacts { list-style: none; padding: 0; }
              .artifacts li { padding: 10px; margin: 5px 0; background: #f8f9fa; border-left: 4px solid #667eea; border-radius: 4px; }
              .artifacts li strong { color: #667eea; }
              .btn { display: inline-block; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; margin: 10px 10px 10px 0; font-weight: bold; }
              .btn:hover { background: #5568d3; }
              .btn-secondary { background: #6c757d; }
              .btn-secondary:hover { background: #5a6268; }
              .code-block { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; overflow-x: auto; margin: 15px 0; }
              .code-block code { font-family: 'Courier New', monospace; font-size: 14px; }
              .footer { text-align: center; padding: 20px; color: #666; font-size: 14px; }
              .success-badge { background: #10b981; color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; font-weight: bold; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>üöÄ Bastion Maven Plugin Community v${VERSION}</h1>
              <p>Successfully Released to Maven Central</p>
              <span class="success-badge">‚úì Build Successful</span>
            </div>

            <div class="content">
              <!-- Release Stats -->
              <div class="section">
                <h2>üìä Release Statistics</h2>
                <div class="stats">
                  <div class="stat-box">
                    <div class="number">${VERSION}</div>
                    <div class="label">Version</div>
                  </div>
                  <div class="stat-box">
                    <div class="number">${COMMIT_COUNT}</div>
                    <div class="label">Commits</div>
                  </div>
                  <div class="stat-box">
                    <div class="number">${PR_COUNT}</div>
                    <div class="label">Pull Requests</div>
                  </div>
                  <div class="stat-box">
                    <div class="number">${CONTRIBUTORS}</div>
                    <div class="label">Contributors</div>
                  </div>
                </div>
              </div>

              <!-- Installation -->
              <div class="section">
                <h2>üíª Installation</h2>
                <p>Add the following plugin to your Maven <code>pom.xml</code>:</p>
                <div class="code-block">
                  <code>&lt;plugin&gt;
              &lt;groupId&gt;io.github.dodogeny&lt;/groupId&gt;
              &lt;artifactId&gt;bastion-maven-community-plugin&lt;/artifactId&gt;
              &lt;version&gt;${VERSION}&lt;/version&gt;
          &lt;/plugin&gt;</code>
                </div>
              </div>

              <!-- Distribution Artifacts -->
              <div class="section">
                <h2>üì¶ Distribution Artifacts</h2>
                <ul class="artifacts">
                  <li><strong>Windows/Cross-Platform:</strong> bastion-maven-plugin-${VERSION}-bin.zip <em>(${BIN_SIZE})</em></li>
                  <li><strong>Unix/Linux/macOS:</strong> bastion-maven-plugin-${VERSION}-bin-unix.tar.gz <em>(${UNIX_SIZE})</em></li>
                  <li><strong>Documentation:</strong> bastion-maven-plugin-${VERSION}-docs.zip <em>(${DOCS_SIZE})</em></li>
                  <li><strong>Source Code:</strong> bastion-maven-plugin-${VERSION}-src.zip & .tar.gz</li>
                </ul>
                <p><small>All artifacts include GPG signatures (.asc) and SHA-256 checksums (.sha256) for verification.</small></p>
              </div>

              <!-- What's Changed -->
              <div class="section">
                <h2>üìù What's Changed</h2>
                <p>This release includes <strong>${COMMIT_COUNT} commits</strong> since ${PREV_TAG:-the beginning}.</p>
                <p>For detailed release notes, see the GitHub release page.</p>
              </div>

              <!-- Links -->
              <div class="section">
                <h2>üîó Quick Links</h2>
                <a href="${RELEASE_URL}" class="btn">View Release on GitHub</a>
                <a href="${MAVEN_CENTRAL_URL}" class="btn btn-secondary">View on Maven Central</a>
                <br>
                <a href="https://github.com/${{ github.repository }}" class="btn btn-secondary">Repository</a>
                <a href="https://github.com/${{ github.repository }}/blob/main/README.md" class="btn btn-secondary">Documentation</a>
              </div>

              <!-- Deployment Info -->
              <div class="section">
                <h2>‚ÑπÔ∏è Deployment Information</h2>
                <ul>
                  <li><strong>Released:</strong> $(date -u +"%Y-%m-%d %H:%M:%S UTC")</li>
                  <li><strong>Workflow:</strong> <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View workflow run</a></li>
                  <li><strong>Commit:</strong> <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">${{ github.sha }}</a></li>
                  <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
                </ul>
              </div>
            </div>

            <div class="footer">
              <p>This is an automated notification from GitHub Actions.</p>
              <p><a href="https://github.com/${{ github.repository }}">Bastion Maven Plugin Community</a> | Apache License 2.0</p>
            </div>
          </body>
          </html>
          EOF

          echo "Email content prepared"

          # Save summary for plain text version
          cat > email_body.txt <<EOF
          Bastion Maven Plugin Community v${VERSION} Released

          Release Statistics:
          - Version: ${VERSION}
          - Commits: ${COMMIT_COUNT}
          - Pull Requests: ${PR_COUNT}
          - Contributors: ${CONTRIBUTORS}

          Installation:
          <plugin>
            <groupId>io.github.dodogeny</groupId>
            <artifactId>bastion-maven-community-plugin</artifactId>
            <version>${VERSION}</version>
          </plugin>

          Distribution Artifacts:
          - Windows/Cross-Platform: bastion-maven-plugin-${VERSION}-bin.zip (${BIN_SIZE})
          - Unix/Linux/macOS: bastion-maven-plugin-${VERSION}-bin-unix.tar.gz (${UNIX_SIZE})
          - Documentation: bastion-maven-plugin-${VERSION}-docs.zip (${DOCS_SIZE})
          - Source Code: Available in .zip and .tar.gz formats

          All artifacts include GPG signatures and SHA-256 checksums.

          Quick Links:
          - GitHub Release: ${RELEASE_URL}
          - Maven Central: ${MAVEN_CENTRAL_URL}
          - Repository: https://github.com/${{ github.repository }}

          Deployment Information:
          - Released: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - Workflow Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          - Commit: ${{ github.sha }}
          - Triggered by: ${{ github.actor }}

          ---
          This is an automated notification from GitHub Actions.
          EOF

      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          # Port 587 uses STARTTLS (not direct SSL) - do not set secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚úÖ Bastion Maven Plugin v${{ needs.preflight.outputs.version }} Released to Maven Central"
          to: ${{ secrets.RELEASE_NOTIFICATION_EMAIL }}
          from: "Bastion CI/CD <${{ secrets.SMTP_USERNAME }}>"
          html_body: file://email_body.html
          body: file://email_body.txt
          priority: normal

      - name: Confirm email sent
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          EMAIL="${{ secrets.RELEASE_NOTIFICATION_EMAIL }}"

          echo "‚úÖ Release notification email sent successfully"
          echo "   Version: v${VERSION}"
          echo "   Recipient: ${EMAIL}"
          echo "   Time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Release summary
    needs: [preflight, build, release, github-release, notify]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          VERSION="${{ needs.preflight.outputs.version }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          echo "# üöÄ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run**: ${DRY_RUN:-false}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-flight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Maven Central Release | ${{ needs.release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | ${{ needs.github-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Email Notification | ${{ needs.notify.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.github-release.result }}" == "success" ]; then
            echo "## üì¶ Release Links" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "- [Maven Central](https://central.sonatype.com/artifact/io.github.dodogeny/bastion-maven-community-plugin/${VERSION})" >> $GITHUB_STEP_SUMMARY
            echo "- [Deployment Status](https://central.sonatype.com/publishing/deployments)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by GitHub Actions*" >> $GITHUB_STEP_SUMMARY
